name: Build RT-AC1200G+ Firmware

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Install dependencies
      run: |
        sudo dpkg --add-architecture i386
        sudo apt-get update
        sudo apt-get install -y \
          build-essential gcc g++ make cmake patch git unzip wget \
          libncurses5-dev m4 bison gawk flex zlib1g-dev autoconf autopoint \
          libtool shtool autogen mtd-utils intltool sharutils \
          docbook-xsl xsltproc u-boot-tools device-tree-compiler \
          python2 gperf liblzo2-dev uuid-dev lzma-dev liblzma-dev \
          binutils-dev dos2unix qemu \
          libglib2.0-dev gtk-doc-tools \
          libc6-i386 lib32stdc++6 lib32z1 libelf1:i386 libncurses5:i386

    - name: Download ASUS GPL source
      run: |
        wget https://dlcdnets.asus.com/pub/ASUS/wireless/RT-AC1200G+/GPL_RT_AC1200GPlus_300438252272.zip -O GPL_RT_AC1200GPlus.zip

        # 解压 zip 得到 tgz
        unzip GPL_RT_AC1200GPlus.zip

        # 直接解压 tgz 到 asuswrt 目录
        tar -xzf GPL_RT-AC1200G+_3.0.0.4.382.52272-g73d3ea2_fix.tgz

    - name: Setup toolchain and build firmware
      run: |
        SRC_DIR=asuswrt/release/src-rt-9.x/src
        TOOLCHAIN_DIR=asuswrt/toolchain/toolchain

        echo "SRC_DIR=$SRC_DIR"
        echo "TOOLCHAIN_DIR=$TOOLCHAIN_DIR"

        # 添加 toolchain/bin 到 PATH
        echo "$TOOLCHAIN_DIR/bin" >> $GITHUB_PATH

        # 进入源码目录并编译
        cd $SRC_DIR
        make RT-AC1200G+

    - name: Upload firmware artifact
      uses: actions/upload-artifact@v4
      with:
        name: firmware
        path: asuswrt/release/src-rt-9.x/src/images/*.trx
